# MySmartRoute

Αυτό το project είναι παράδειγμα εφαρμογής Android.
Προς το παρόν έχει απενεργοποιηθεί το Firebase App Check ώστε να μπορείτε να κάνετε είσοδο χωρίς επιπλέον έλεγχο.
Επιπλέον, η εγγραφή δεν απαιτεί πλέον επιβεβαίωση μέσω SMS.

## Σύνοψη τελευταίων 10 commits

1. **36a6da7 – Notify drivers when passengers submit transfer requests (#1839)**
   Συγχωνεύει τη λειτουργία ειδοποιήσεων οδηγών όταν ένας επιβάτης υποβάλλει νέο αίτημα μεταφοράς.
   Διατηρεί τα δεδομένα του αιτήματος ακόμα κι αν η αποστολή push αποτύχει, παρέχοντας αναλυτικό logging.
2. **018b7f8 – Notify drivers about new transfer requests**
   Προσθέτει λογική `shouldNotifyDrivers` ώστε μετά την επιτυχημένη εισαγωγή στο Firestore να εντοπίζεται πότε απαιτείται ειδοποίηση οδηγών.
   Καλεί την `notifyDriversAboutRequest` με ασφάλεια, απομονώνοντας τυχόν εξαιρέσεις και καταγράφοντας το σφάλμα χωρίς να αναιρεί την υποβολή.
3. **9312458 – Fix TimePickerDialog reference in BookSeatScreen (#1838)**
   Ενσωματώνει στο κύριο branch τη διόρθωση του time picker αντικαθιστώντας το εξαρτώμενο `TimePickerDialog` με ένα απλό wrapper.
   Εξασφαλίζει ότι η οθόνη κράτησης μπορεί να δομεί το διάλογο χρόνου μέσω `AlertDialog`, αποφεύγοντας crashes σε σταθερές εκδόσεις Compose.
4. **5a03e41 – Provide Compose time picker dialog fallback**
   Αντικαθιστά το import του Material3 `TimePickerDialog` με `AlertDialog` και ορίζει νέο composable `TimePickerDialog` wrapper.
   Επιτρέπει τη χρήση του ίδιου API στην `BookSeatScreen` διατηρώντας το layout του picker χωρίς εξάρτηση από alpha components.
5. **150eba4 – Display route names and stops in transfer request screens (#1837)**
   Συγχωνεύει τις βελτιώσεις απεικόνισης διαδρομών σε λίστες αιτημάτων μεταφοράς για επιβάτες και οδηγούς.
   Επισημαίνει πλέον τα ονόματα διαδρομών και διαχωρίζει τις στάσεις σε ξεχωριστή στήλη, βελτιώνοντας την αναγνωσιμότητα.
6. **1792c95 – Show route name and stops on transport request screens**
   Προσθέτει νέα κεφαλίδα "Stops" και υπολογίζει `stationsText` με τα ονόματα έναρξης/λήξης για κάθε αίτημα.
   Χρησιμοποιεί το αποθηκευμένο `routeName` όταν υπάρχει και παρουσιάζει τις στάσεις σε ξεχωριστή στήλη και για τα δύο dashboards.
7. **8230e72 – Περιορισμός δημιουργίας εγγραφών transfer_requests (#1836)**
   Συγχωνεύει τον έλεγχο συγχρονισμού που αποτρέπει την απροϋπόθετη δημιουργία εγγραφών `transfer_requests` από το cloud.
   Ευθυγραμμίζει τον κώδικα της `DatabaseViewModel` ώστε οι ενημερώσεις να εφαρμόζονται μόνο σε ήδη υπάρχοντα τοπικά αιτήματα.
8. **d61fbf3 – Περιορισμός ενημέρωσης transfer_requests από συγχρονισμό**
   Εισάγει συλλογή όλων των τοπικών `requestNumber` και φιλτράρει τις remote εγγραφές πριν τις εισάγει στη Room.
   Έτσι τα δεδομένα συγχρονισμού ενημερώνουν μόνο υπάρχοντα αιτήματα, αποφεύγοντας διπλότυπες ή κενές εγγραφές.
9. **05b9b21 – Αποφυγή δημιουργίας εσφαλμένων εγγραφών αιτημάτων μεταφοράς (#1835)**
   Συγχωνεύει την αναδιάρθρωση της `submitRequest` που διαχειρίζεται την υποβολή σε Firestore πριν την αποθήκευση στη Room.
   Περιλαμβάνει καθαρισμό δεδομένων και rollback σε περίπτωση αποτυχίας, αποτρέποντας την εγγραφή ελλιπών αιτημάτων.
10. **7dd6dbe – Merge branch 'master' into codex/fix-transfer_requests-record-creation-issue**
   Συγχωνεύει το branch με την τρέχουσα `master`, φέρνοντας ενημερώσεις σε ροή κράτησης, πλοήγηση και μεταφράσεις.
   Ενημερώνει το `TransferRequestViewModel` και σχετικά UI ώστε να παραμένουν συμβατά με τις πρόσφατες αλλαγές της κεντρικής βάσης κώδικα.

Από την έκδοση 1.0  H Πρώτη κυκλοφορία της εφαρμογής με βασική λειτουργικότητα και αρχική διαμόρφωση του build.gradle.kts όπου ορίζεται versionName = "1.0" και versionCode = 1\
Από την έκδοση 1.1  Προσθήκη πλοήγησης (navigation drawer) και βασικών οθονών.
Από την έκδοση 1.2  Επιμονή των ρυθμίσεων και συγχρονισμός δεδομένων μεταξύ χρηστών.
Από την έκδοση 1.3  Προσθήκη πληροφοριών έκδοσης και λογότυπου στην οθόνη “About”.
Από την έκδοση 1.4  ο χάρτης έχει πλέον σταθερό ύψος και εμφανίζεται σωστά.
Από την έκδοση 1.7  το μενού επιλογών είναι πλέον έτοιμο.
Από την έκδοση 1.8  το μενού χρήστη υλοποιήθηκε με κληρονομικότητα.
Από την έκδοση 1.9  τα στοιχεία του UI ακολουθούν τα χρώματα του θέματος.
Από την έκδοση 1.10 τα μενού ορίζονται στο menus.json με ιεραρχία ρόλων.
Από την έκδοση 2.0  εμφανίζεται περιγραφή του μενού ανά ρόλο και προστέθηκε η οθόνη «Ορισμός σημείου ενδιαφέροντος» για τους διαχειριστές.
Από την έκδοση 2.1  οι διευθύνσεις των POI αποθηκεύονται και ομαδοποιημένες στο Firestore.
Από την έκδοση 2.2  ολοκληρώθηκε η επιλογή «Ορισμός σημείου ενδιαφέροντος» στο μενού του διαχειριστή.
Από την έκδοση 2.3  προστέθηκε η οθόνη «Επεξεργασία διαδρομής» για εισαγωγή πολλαπλών POI.
Από την έκδοση 2.4  ξεκίνησε η υλοποίηση της οθόνης «Δήλωση μεταφοράς».
Από την έκδοση 2.5  προστέθηκε ένδειξη προόδου στην οθόνη «Δήλωση μεταφοράς».
Από την έκδοση 2.6  επιτρέπεται η διαγραφή σημείων από τη «Δήλωση μεταφοράς» πατώντας στο marker και έπειτα στο κουμπί με το εικονίδιο "Χ".
Από την έκδοση 2.7  προστέθηκε πεδίο ονόματος διαδρομής, βελτιώθηκε η αλληλεπίδραση με τον χάρτη και διορθώθηκαν προβλήματα αποθήκευσης.
Από την έκδοση 2.8  υλοποιήθηκε η οθόνη «Καταχώρηση οχήματος» και προστέθηκε περιγραφή εκκίνησης.
Από την έκδοση 2.9  η οθόνη «Προετοιμασία ολοκλήρωσης διαδρομής» εμφανίζει τις κρατήσεις ακόμα και χωρίς σύνδεση.
Από την έκδοση 2.10 βελτιώθηκε η διαχείριση σφαλμάτων δικτύου στους χάρτες και αυξήθηκαν τα χρονικά περιθώρια των αιτημάτων προς το Directions API.
Από την έκδοση 2.11 διορθώθηκε πρόβλημα με τον DatePicker στην οθόνη «Λειτουργία διαδρομής» που προκαλούσε σφάλματα μεταγλώττισης.
Από την έκδοση 2.12 ενημερώθηκαν οι βιβλιοθήκες Firebase ώστε να αποφεύγονται σφάλματα επίλυσης εξαρτήσεων.
Από την έκδοση 2.13 προστέθηκε προβολή διαδρομών πεζών από το Firestore και πίνακας μη εκχωρημένων διαδρομών.
Από την έκδοση 2.14 η αναζήτηση οχήματος εμπλουτίστηκε με επιπλέον φίλτρα και απλοποιήθηκε βάσει κόστους, οι δηλώσεις μεταφοράς περιορίζονται σε μελλοντικές, οι ολοκληρωμένες μεταφορές δεν εμφανίζονται στη λίστα διαθέσιμων, οι ληγμένες αιτήσεις επισημαίνονται ως ανεπιτυχείς και υποστηρίζεται προβολή διαδρομών με κόστος μικρότερο ή ίσο.
Από την έκδοση 2.15 αφαιρέθηκε η περιγραφή επιβάτη από το μενού, ευθυγραμμίζοντας την εμπειρία με αυτή των οδηγών.
Από την έκδοση 2.16 προστέθηκε συγχρονισμός οχημάτων όταν η βάση είναι κενή, δημιουργήθηκε migration 62→63 και βελτιώθηκε η καταγραφή ενεργειών.
Από την έκδοση 2.17 ο υπολογισμός διάρκειας διαδρομής υποστηρίζει πολλαπλά POI και τα οχήματα αποθηκεύονται στη Room σε κάθε περίπτωση.
Από την έκδοση 2.18 περιορίζονται οι διαδρομές λεωφορείων σε οχήματα λεωφορείων και διορθώνονται ζητήματα επιλογής ημερομηνίας.
Από την έκδοση 2.19 προστέθηκαν λεπτομέρειες σε εκτύπωση εισιτηρίων, προβολή κράτησης και νέα κατάσταση OPEN.
                    Η αναζήτηση επιβατών και το φιλτράρισμα μετακινήσεων αξιοποιούν πλέον αποθηκευμένο χρόνο εφαρμογής.
                    Οι ληγμένες μετακινήσεις σημαίνονται αυτόματα ως ανεπιτυχείς και εμφανίζονται μόνο εκκρεμείς/ανεπιτυχείς/ολοκληρωμένες.
Από την έκδοση 2.20 ενσωματώνεται χάρτης στην ανασκόπηση PoI, επεκτείνεται ο έλεγχος διπλών διαδρομών και στρογγυλοποιούνται τα
                    κουμπιά αναθεώρησης.
Από την έκδοση 2.21 η αναζήτηση οχήματος εμφανίζει ταυτόχρονα τοπικές και απομακρυσμένες διαδρομές,
                    επιτρέποντας κύλιση στην ανασκόπηση και διασφαλίζοντας ορθή φόρτωση `routeId` από το Firestore.
Από την έκδοση 2.22 προστέθηκε πλήρης οθόνη συγχρονισμού για διαχειριστές με καρτέλες για τοπική βάση και Firestore,
                    παρέχοντας ζωντανή απεικόνιση προόδου και σαφή τίτλους για κάθε πίνακα δεδομένων.
Από την έκδοση 2.23 βελτιώθηκε η καταγραφή συμβάντων συγχρονισμού και αρχικοποίησης βάσης,
                    προστέθηκαν χρονικές σφραγίδες στις ενδείξεις και σταθεροποιήθηκαν οι εξαρτήσεις φόρτωσης Firebase.


Για να λειτουργήσει ο χάρτης χρειάζεται να ορίσεις το Google Maps API key στο
`local.properties` της ρίζας του project:

```
MAPS_API_KEY=YOUR_API_KEY
```

Αντικατέστησε το `YOUR_API_KEY` με το πραγματικό κλειδί από το Google Cloud Console.

Το `app/build.gradle.kts` πλέον διαβάζει αυτόματα την τιμή από το `local.properties`,
οπότε αρκεί να προσθέσεις τη γραμμή με το κλειδί και να κάνεις "Sync Project" ή
"Rebuild" για να παραχθεί το `BuildConfig`.
Επιπλέον, φρόντισε να έχεις ενεργοποιήσει το **Maps SDK for Android** στο Google Cloud
και να μην περιορίζεται το κλειδί σε συγκεκριμένο package μέχρι να το προσθέσεις στο project.

Σε περιβάλλοντα CI μπορείς εναλλακτικά να ορίσεις τη μεταβλητή περιβάλλοντος
`MAPS_API_KEY` ώστε το Gradle script να χρησιμοποιήσει το κλειδί χωρίς να
απαιτείται αρχείο `local.properties`.

Μπορείς να επιβεβαιώσεις ότι το κλειδί φορτώθηκε σωστά προσθέτοντας στο κώδικα το παρακάτω απόσπασμα:

```kotlin
val apiKey = MapsUtils.getApiKey(context)
Log.d("Maps", "API key loaded? ${apiKey.isNotEmpty()}")
```

Έτσι θα δεις ένα μήνυμα στο log που επιβεβαιώνει ότι η εφαρμογή διαβάζει το κλειδί.

Αν αντιμετωπίσεις το σφάλμα **"Unresolved reference: BuildConfig"**, έλεγξε τα παρακάτω:

1. Σιγουρέψου ότι έχεις προσθέσει το import

   ```kotlin
   import com.ioannapergamali.mysmartroute.BuildConfig
   ```

   στην αρχή του αρχείου Kotlin όπου χρησιμοποιείς το `BuildConfig`.
2. Επιβεβαίωσε ότι στο `app/build.gradle.kts` είναι ενεργοποιημένο το `buildConfig`
   μέσω της επιλογής:

   ```kotlin
   buildFeatures {
       buildConfig = true
   }
   ```

3. Τέλος, κάνε "Sync Project with Gradle Files" ώστε να παραχθεί ξανά το αρχείο
   `BuildConfig`. Μετά την επιτυχημένη συγχρονίση, το σφάλμα θα εξαφανιστεί.

### Αν ο χάρτης δεν εμφανίζεται

Αν παρά τις παραπάνω ενέργειες το log γράφει `Maps API key loaded: false` και
βλέπεις στην οθόνη το μήνυμα «Google Maps API key is missing», δοκίμασε τα
εξής:

1. Βεβαιώσου ότι το `local.properties` βρίσκεται στον ίδιο φάκελο με τα
   `settings.gradle.kts` και `gradlew`.
2. Στο αρχείο να υπάρχει *μία* γραμμή της μορφής:

   ```
   MAPS_API_KEY=TO_DIKO_SOU_API_KEY
   ```

   χωρίς εισαγωγικά ή επιπλέον κενά.
3. Εκτέλεσε «Clean Project» και στη συνέχεια «Rebuild Project» για να παραχθεί
   ξανά το `BuildConfig` με το σωστό κλειδί.

### Αν δεις "Unresolved reference" για το Gson

Εάν η IDE εμφανίζει σφάλματα του τύπου *Unresolved reference: Gson* ή *TypeToken*, έλεγξε ότι στο αρχείο `app/build.gradle.kts` υπάρχει η γραμμή

```kotlin
implementation("com.google.code.gson:gson:2.13.1") // τελευταία διαθέσιμη έκδοση
```

Στη συνέχεια, στις κλάσεις Kotlin πρόσθεσε τα κατάλληλα imports:

```kotlin
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken

private val gson = Gson()

// Μετατροπή JSON σε αντικείμενο Kotlin
val type = object : TypeToken<User>() {}.type
val user: User = gson.fromJson(jsonString, type)
```
Μετά την προσθήκη ή επιβεβαίωση της παραπάνω εξάρτησης, κάνε "Sync Project with Gradle Files" ώστε να κατέβει το library και να λυθούν τα σφάλματα.

### Αν λάβεις "Domain not allowlisted by project" στην επαναφορά κωδικού

Αν κατά την αποστολή email επαναφοράς κωδικού εμφανιστεί το μήνυμα σφάλματος
`Domain not allowlisted by project`, τότε το custom domain των δυναμικών συνδέσμων
δεν έχει προστεθεί στη λίστα επιτρεπόμενων διευθύνσεων του Firebase. Μεταβείτε στο
Firebase console -> Authentication -> Settings -> Authorized domains και προσθέστε
το domain (π.χ. `mysmartroute.page.link`). Αφού επιτρέψετε το domain, το email
επαναφοράς θα σταλεί κανονικά.

### Αν τα κοντινά μέρη επιστρέφουν "null"

Οι λειτουργίες `fetchNearbyPlaceName` και `fetchNearbyPlaceType` χρησιμοποιούν το
Google Places API. Αν στο logcat βλέπεις μηνύματα όπως
`Nearby place name request failed: REQUEST_DENIED` ή οι τιμές
εμφανίζονται `null`, έλεγξε τα εξής:

1. Στη σελίδα Google Cloud Console πρέπει να είναι ενεργό το **Places API**.
2. Το API key δεν πρέπει να περιορίζεται σε λάθος SHA‑1 ή package name. Για δοκιμές
μπορείς προσωρινά να αφαιρέσεις όλους τους περιορισμούς.

Μετά τις αλλαγές κάνε επανεκκίνηση της εφαρμογής ώστε να χρησιμοποιήσει το σωστό κλειδί.



### Εικονίδιο ειδοποίησης

Για να εμφανιστεί σωστά το εικονίδιο στις ειδοποιήσεις, χρησιμοποίησε τον builder του `NotificationCompat` δίνοντας ένα λευκό εικονίδιο vector στο `setSmallIcon`:

```kotlin
val notification = NotificationCompat.Builder(this, CHANNEL_ID)
    .setSmallIcon(R.drawable.ic_notification)
    .setContentTitle("Τίτλος ειδοποίησης")
    .setContentText("Κείμενο ειδοποίησης")
    .setPriority(NotificationCompat.PRIORITY_DEFAULT)
    .build()
```

Το αρχείο `ic_notification.xml` πρέπει να βρίσκεται στο `res/drawable` και να έχει απλή λευκή μορφή ώστε να προβάλλεται σωστά στη γραμμή ειδοποιήσεων.

### Αποδοχή αδειών Android SDK

Για να αποδεχθείς τις άδειες χρήσης του Android SDK σε περιβάλλον Linux:

1. Εγκατάσταση ή ενημέρωση των command-line tools:
   ```bash
   sdkmanager "cmdline-tools;latest"
   ```
2. Εγκατάσταση των απαραίτητων πακέτων (αν λείπουν):
   ```bash
   sdkmanager "build-tools;35.0.0" "platforms;android-35"
   ```
3. Αποδοχή των αδειών:
   ```bash
   sdkmanager --licenses
   ```
4. (Προαιρετικά) Μεταφορά αδειών σε άλλο μηχάνημα:
   - Αντέγραψε τον φάκελο `licenses` από το `$ANDROID_HOME` και τοποθέτησέ τον στο αντίστοιχο directory του νέου μηχανήματος.

Αν δεις μήνυμα όπως
`Failed to install the following Android SDK packages as some licences have not been accepted`,
εκτέλεσε τις παραπάνω εντολές και βεβαιώσου ότι η μεταβλητή `ANDROID_HOME` δείχνει στη σωστή διαδρομή, π.χ. `/usr/lib/android-sdk`.

